/*
 * MapComposerFrame.java
 *
 * Created on July 31, 2007, 9:39 AM
 */
package edu.oregonstate.carto.mapcomposer.gui;

import edu.oregonstate.carto.mapcomposer.Map;
import edu.oregonstate.carto.utils.FileUtils;
import java.io.File;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.xml.bind.JAXBContext;
import javax.xml.bind.JAXBException;
import javax.xml.bind.Marshaller;

/**
 * Main window for composing a map consisting of multiple layers. The UI
 * elements mostly handled by a MapComposerPanel.
 *
 * @author Bernhard Jenny, Institute of Cartography, ETH Zurich.
 * @author Charlotte Hoarau, COGIT Laboratory, IGN France
 */
public class MapComposerFrame extends javax.swing.JFrame {

    /**
     * Creates new form MapComposerFrame
     */
    public MapComposerFrame() {
        initComponents();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        mapComposerPanel = new edu.oregonstate.carto.mapcomposer.gui.MapComposerPanel();
        menuBar = new javax.swing.JMenuBar();
        fileMenu = new javax.swing.JMenu();
        loadDataMenu = new javax.swing.JMenu();
        loadImageDirectoryMenuItem = new javax.swing.JMenuItem();
        loadTileSetDirectoryMenuItem = new javax.swing.JMenuItem();
        jSeparator1 = new javax.swing.JPopupMenu.Separator();
        saveMapMenuItem = new javax.swing.JMenuItem();
        jSeparator2 = new javax.swing.JPopupMenu.Separator();
        loadStyleMenuItem = new javax.swing.JMenuItem();
        saveStyleMenuItem = new javax.swing.JMenuItem();
        mapMenu = new javax.swing.JMenu();
        addLayerMenuItem = new javax.swing.JMenuItem();
        javax.swing.JPopupMenu.Separator jSeparator3 = new javax.swing.JPopupMenu.Separator();
        previewMenuItem = new javax.swing.JMenuItem();
        textureMenu = new javax.swing.JMenu();
        createTextureMenuItem = new javax.swing.JMenuItem();

        setDefaultCloseOperation(javax.swing.WindowConstants.EXIT_ON_CLOSE);
        setResizable(false);

        mapComposerPanel.setBorder(javax.swing.BorderFactory.createEmptyBorder(20, 20, 20, 20));
        getContentPane().add(mapComposerPanel, java.awt.BorderLayout.CENTER);

        fileMenu.setText("File");

        loadDataMenu.setText("Load Data");

        loadImageDirectoryMenuItem.setText("Select Image Directory");
        loadImageDirectoryMenuItem.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                loadImageDirectoryMenuItemActionPerformed(evt);
            }
        });
        loadDataMenu.add(loadImageDirectoryMenuItem);

        loadTileSetDirectoryMenuItem.setText("Select Tile Sets Directory");
        loadTileSetDirectoryMenuItem.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                loadTileSetDirectoryMenuItemActionPerformed(evt);
            }
        });
        loadDataMenu.add(loadTileSetDirectoryMenuItem);

        fileMenu.add(loadDataMenu);
        fileMenu.add(jSeparator1);

        saveMapMenuItem.setText("Save Tiles");
        saveMapMenuItem.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                saveMapMenuItemActionPerformed(evt);
            }
        });
        fileMenu.add(saveMapMenuItem);
        fileMenu.add(jSeparator2);

        loadStyleMenuItem.setText("Load Map Settings");
        loadStyleMenuItem.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                loadStyleMenuItemActionPerformed(evt);
            }
        });
        fileMenu.add(loadStyleMenuItem);

        saveStyleMenuItem.setText("Save Map Settings");
        saveStyleMenuItem.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                saveStyleMenuItemActionPerformed(evt);
            }
        });
        fileMenu.add(saveStyleMenuItem);

        menuBar.add(fileMenu);

        mapMenu.setText("Map");

        addLayerMenuItem.setAccelerator(javax.swing.KeyStroke.getKeyStroke(java.awt.event.KeyEvent.VK_N,    java.awt.Toolkit.getDefaultToolkit().getMenuShortcutKeyMask()));
        addLayerMenuItem.setText("Add Layer");
        addLayerMenuItem.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                addLayerMenuItemActionPerformed(evt);
            }
        });
        mapMenu.add(addLayerMenuItem);
        mapMenu.add(jSeparator3);

        previewMenuItem.setAccelerator(javax.swing.KeyStroke.getKeyStroke(java.awt.event.KeyEvent.VK_P,    java.awt.Toolkit.getDefaultToolkit().getMenuShortcutKeyMask()));
        previewMenuItem.setText("Preview");
        previewMenuItem.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                previewMenuItemActionPerformed(evt);
            }
        });
        mapMenu.add(previewMenuItem);

        menuBar.add(mapMenu);

        textureMenu.setText("Texture");

        createTextureMenuItem.setText("Create Texture");
        createTextureMenuItem.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                createTextureMenuItemActionPerformed(evt);
            }
        });
        textureMenu.add(createTextureMenuItem);

        menuBar.add(textureMenu);

        setJMenuBar(menuBar);

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void loadImageDirectoryMenuItemActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_loadImageDirectoryMenuItemActionPerformed
        /*try {
            String directoryPath = FileUtils.askDirectory(this, "Image Directory", true, null);
            if (directoryPath == null) {
                // user canceled
                return;
            }
            ImageCollection imageCollection = new DirectoryImageCollection(directoryPath);
            mapComposerPanel.setImageCollection(imageCollection);

            // FIXME size of resulting image must be derived from input images
            mapComposerPanel.getMap().setImageHeight(1000);
            mapComposerPanel.getMap().setImageWidth(1000);
            mapComposerPanel.getMap().setImage(new BufferedImage(1000, 1000, BufferedImage.TYPE_INT_ARGB));

        } catch (IOException ex) {
            String msg = "An error occured when reading the image directory.";
            ErrorDialog.showErrorDialog(msg, "Error", ex, GUIUtil.getOwnerFrame(this));
        }
        */ 
    }//GEN-LAST:event_loadImageDirectoryMenuItemActionPerformed

    private void loadTileSetDirectoryMenuItemActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_loadTileSetDirectoryMenuItemActionPerformed
        /*try {
            String directoryPath = FileUtils.askDirectory(this, "Directory with Tiles Collections", true, null);
            if (directoryPath == null) {
                // user canceled
                return;
            }
            ImageCollection imageCollection = new TiledImageCollection(directoryPath);
            mapComposerPanel.setImageCollection(imageCollection);

            // FIXME
            //TODO Adapt if layers have different tile sizes
            int tileSize = ((TiledImageCollection) mapComposerPanel.getImageCollection()).getLayers().get(0).getTileSize();
            mapComposerPanel.getMap().setImageHeight(tileSize);
            mapComposerPanel.getMap().setImageWidth(tileSize);
            mapComposerPanel.getMap().setTiledImage(new TiledImage(FileUtils.createTempDirectory().getAbsolutePath()));

        } catch (IOException ex) {
            String msg = "An error occured when reading the tiles collection directory.";
            ErrorDialog.showErrorDialog(msg, "Error", ex, GUIUtil.getOwnerFrame(this));
        }
        * */
    }//GEN-LAST:event_loadTileSetDirectoryMenuItemActionPerformed

    private void loadStyleMenuItemActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_loadStyleMenuItemActionPerformed
        String filePath = FileUtils.askFile(null, "Load Style.xml file", null, true, "xml");
        if (filePath != null) {
            mapComposerPanel.setMap(Map.unmarshal(filePath));
        }
    }//GEN-LAST:event_loadStyleMenuItemActionPerformed

    private void saveMapMenuItemActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_saveMapMenuItemActionPerformed
        /*
        try {
            File styleFile = null;
            Map map = mapComposerPanel.getMap();
            ImageCollection imageCollection = mapComposerPanel.getImageCollection();

            // make sure the latest user settings are used
            mapComposerPanel.readGUI();

            if (imageCollection instanceof DirectoryImageCollection) {
                String filePath = FileUtils.askFile(null, "Save PNG Image", null, false, "png");
                if (filePath == null) {
                    return;
                }

                MapTileGenerator generator = new MapTileGenerator(map, imageCollection);
                ImageIO.write(generator.createTile("map"), "png", new File(filePath));
                styleFile = new File(FileUtils.getFileNameWithoutExtension(new File(filePath).getName()) + "_style");
            } else if (imageCollection instanceof TiledImageCollection) {
                String directoryPath = FileUtils.askDirectory(null, "Save Tiled Images", false, null);
                if (directoryPath == null) {
                    return;
                }
                File resultDirectory = new File(directoryPath);
                resultDirectory.mkdir();

                TileGenerator generator = new MapTileGenerator(map, imageCollection);
                map.setTiledImage(new TiledImage(resultDirectory.getAbsolutePath()));

                // FIXME there should be a better way to specify the required extent and zoom levels
                File refDir = ((TiledImageCollection) (imageCollection)).getRefDir();
                map.getTiledImage().createTiledImage(refDir, true, generator, null);

                File htmlFile = mapComposerPanel.copyHTML(resultDirectory.getPath());
                Desktop.getDesktop().browse(htmlFile.toURI());

                styleFile = new File(resultDirectory, resultDirectory.getName());
            }
            if (styleFile != null) {
                map.marshal(styleFile.getAbsolutePath() + ".xml");
            }
        } catch (Exception exc) {
            ErrorDialog.showErrorDialog("The image could not be saved.", exc);
        }
        */ 
    }//GEN-LAST:event_saveMapMenuItemActionPerformed

    private void saveStyleMenuItemActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_saveStyleMenuItemActionPerformed

            String filePath = FileUtils.askFile(null, "Save XML Style", null, false, "xml");
            if (filePath == null) {
                return;
            }
            File file = new File(filePath);
            mapComposerPanel.getMap().marshal(file.getAbsolutePath());
    }//GEN-LAST:event_saveStyleMenuItemActionPerformed

    private void createTextureMenuItemActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_createTextureMenuItemActionPerformed
        // FIXME new TextureComposerFrame().setVisible(true);
    }//GEN-LAST:event_createTextureMenuItemActionPerformed

    private void addLayerMenuItemActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_addLayerMenuItemActionPerformed
        mapComposerPanel.addLayer();
    }//GEN-LAST:event_addLayerMenuItemActionPerformed

    private void previewMenuItemActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_previewMenuItemActionPerformed
        mapComposerPanel.previewMap();
    }//GEN-LAST:event_previewMenuItemActionPerformed

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JMenuItem addLayerMenuItem;
    private javax.swing.JMenuItem createTextureMenuItem;
    private javax.swing.JMenu fileMenu;
    private javax.swing.JPopupMenu.Separator jSeparator1;
    private javax.swing.JPopupMenu.Separator jSeparator2;
    private javax.swing.JMenu loadDataMenu;
    private javax.swing.JMenuItem loadImageDirectoryMenuItem;
    private javax.swing.JMenuItem loadStyleMenuItem;
    private javax.swing.JMenuItem loadTileSetDirectoryMenuItem;
    private edu.oregonstate.carto.mapcomposer.gui.MapComposerPanel mapComposerPanel;
    private javax.swing.JMenu mapMenu;
    private javax.swing.JMenuBar menuBar;
    private javax.swing.JMenuItem previewMenuItem;
    private javax.swing.JMenuItem saveMapMenuItem;
    private javax.swing.JMenuItem saveStyleMenuItem;
    private javax.swing.JMenu textureMenu;
    // End of variables declaration//GEN-END:variables
}
